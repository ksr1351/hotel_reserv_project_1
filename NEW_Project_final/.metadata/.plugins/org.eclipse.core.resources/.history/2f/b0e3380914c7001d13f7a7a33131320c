<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<link type="text/css" rel="stylesheet" href="/resources/css/bootstrap.min.css" />

<script>
function loadReviewList(hotel_code) {
	$.ajax({
        url: "/detail/getReviews?hotel_code=" + hotel_code,
        type: "GET",
        dataType: "json",
        success: function (response) {
            var reviewListHtml = '';
            var reviewList = response.reviewList;
            
            if (reviewList.length === 0) {
                reviewListHtml = '<p>작성된 리뷰가 없습니다!</p>';
            } else {
            	for (var i = 0; i < reviewList.length; i++) {
                    var review = reviewList[i];
                    reviewListHtml += '<div class= "container">';
                    reviewListHtml += '<div class="review text-center">';
                    reviewListHtml += '<h3>' + review.room_name + ' | ' + review.name + '</h3>';
                    reviewListHtml += '<div class="content"><p>' + review.content + '</p></div>';
                    reviewListHtml += '<div class="rating_value"><p>Rating: ' + review.rating_value + '</p></div>';
                    reviewListHtml += '<div><img src="' + review.filepath + '" alt="' + review.filename + '" width="100" height="100" /></div>';
                    reviewListHtml += '=========================';
                    reviewListHtml += '<input class = "form-control" type="button" id="update" data-review-code="' + review.review_code + '"value="수정" />';
                    reviewListHtml += '<input class = "form-control" type="button" id="delete" data-review-code="' + review.review_code + '"value="삭제" />';
                    reviewListHtml += '<br/>';
                    reviewListHtml += '</div>';
                    reviewListHtml += '</div>';
                }
            	// update rating
                var rating = response.rating;
                $('#rating_avg_1').html('<p>평균 평점 : ' + rating.rating_avg + '</p>');
                $('#rating_avg_2').html('<p>평균 평점 : ' + rating.rating_avg + '</p>');
                $('#rating_cnt').html('<p>평점 개수 : ' + rating.rating_cnt + '</p>');
            }
            $('#reviewList').html(reviewListHtml); 
        },
        error: function (xhr, textStatus, errorThrown) {
            alert('Error: ' + textStatus);
        }
    });
}

var hotel_code = ${hotel_code};

$(document).ready(function () {
	// 리뷰 리스트 불러오기
	loadReviewList(hotel_code);
    
	// 리뷰 작성 폼 불러오기
    $('#writeBtn').on('click', function() {
    	$('#reviewFormContainer').show();
    });
    
	// 리뷰 작성 요청
    $('#insert').on('click', function() {
    	var formData = new FormData($('#reviewFrm')[0]);
    	
    	$.ajax({
    		url: '/insertReview',
    		// url: '/insertReview?hotel_code=' + hotel_code,
    		type: 'POST',
    		data: formData,
    		processData: false,
    		contentType: false,
    		success: function(response) {
    			if(response == 'success') {
    				alert('리뷰 작성 완료!');
    				loadReviewList(hotel_code);
    			} else {
    				alert('리뷰 작성 중 에러!');
    			}
    		},
    		error: function (xhr, textStatus, errorThrown) {
                alert('Error: ' + textStatus);
            }
    	});
    	$('#reviewFormContainer').hide();
    	
//     	$.ajax({
//     		url: '/insertReview?hotel_code=' + hotel_code,
//     		type: 'POST',
//     		data: $('#reviewFrm').serialize(),
//     		success: function(response) {
//     			if(response == 'success') {
//     				alert('리뷰 작성 완료!');
//     				loadReviewList(hotel_code);
//     			} else {
//     				alert('리뷰 작성 중 에러!');
//     			}
//     		},
//     		error: function (xhr, textStatus, errorThrown) {
//                 alert('Error: ' + textStatus);
//             }
//     	});
//     	$('#reviewFormContainer').hide();
    });
});

// 리뷰 수정 폼 불러오기
$(document).on('click', '#update', function () {
    var reviewDiv = $(this).closest('.review');
    var review_code = $(this).data('review-code');
    var content = reviewDiv.find('.content').text();
    var rating_value = reviewDiv.find('.rating_value').text();

    // 현재 리뷰 숨기기
    reviewDiv.hide();
    
    var editForm = '<div id="editFormContainer' + review_code + '" class="editFormContainer">';
    editForm += '<form id="editForm" data-review-code="' + review_code + '">';
    editForm += '<div>내용 : <textarea id="editContent" name="content">' + content + '</textarea></div>';
    editForm += '<div>평점 : <input type="number" id="editRatingValue" name="rating_value" value="' + rating_value + '" /></div>';
    editForm += '<input type="button" id="submitEdit" value="완료" />';
    editForm += '<input type="button" id="cancelEdit" value="취소" />';
    editForm += '</form>';
    editForm += '</div>';
	
    // 숨겨진 리뷰 다음 리뷰 수정 폼 출력
    reviewDiv.after(editForm);
});

// 리뷰 수정 요청
$(document).on('click', '#submitEdit', function () {
    var form = $(this).closest('form');
    var review_code = form.data('review-code');
    var editedContent = form.find('#editContent').val();
    var editedRatingValue = form.find('#editRatingValue').val();

    $.ajax({
        url: '/updateReview',
        type: 'PUT',
        contentType: 'application/json', // Content type 'application/x-www-form-urlencoded;charset=UTF-8' not supported
        data: JSON.stringify ({ // JSON parse error:
            review_code: review_code,
            content: editedContent,
            rating_value: editedRatingValue
        }),
        success: function (response) {
            if (response == 'success') {
                alert('리뷰 수정 완료!');
                loadReviewList(hotel_code);
                
                $('#editFormContainer' + review_code).remove();
                $('.review').show();
            } else {
                alert('리뷰 수정 실패!');
            }
        },
        error: function (xhr, textStatus, errorThrown) {
            alert('Error: ' + textStatus);
        }
    });
});

// 리뷰 수정 중 취소 요청
$(document).on('click', '#cancelEdit', function () {
    loadReviewList(hotel_code);
});

//리뷰 작성 중 취소 요청
$(document).on('click', '#cancelInsert', function () {
	$('#reviewFormContainer').hide();
    loadReviewList(hotel_code);
});

//리뷰 삭제
$(document).on('click', '#delete', function() {
	var review_code = $(this).data('review-code');
    	
   	if (confirm('정말로 삭제하시겠습니까?')) {
   		$.ajax({
   			url: '/deleteReview?review_code=' + review_code,
   			type: 'DELETE',
   			success: function(response) {
   				alert('리뷰 삭제 완료!');
   				loadReviewList(hotel_code);
   			},
   			error: function(xhr, textStatus, errorThrown) {
   				alert('Error: ' + textStatus);
   			}
   		});
   	}
});

</script>
</head>
<body>
	<table>
		<c:forEach items="${hotelSubInfo}" var="dto">
			<tr>
		   		<td rowspan="${fn:length(dto.imageDTO)}">
		   			Name: ${dto.name}
		   			<br>
		   			Type: ${dto.type}
		   			<br>
		   			Addr: ${dto.hotel_detail_address}
		   			<br>
		   			<div id="rating_avg_1"></div>
		   		</td>
		    	<c:forEach items="${dto.imageDTO}" var="image" varStatus="status">
		        	<c:if test="${status.index > 0}">
		           		<tr>
		       		</c:if>
		        	<td>
		            	<img src="/resources/images/hotel_sub_img/${image.filepath}" alt="${image.filename}" width="100" height="100" />
		        	</td>
		        	<c:if test="${status.index > 0}">
		            	</tr>
		        	</c:if>
		    	</c:forEach>
			</tr>
		</c:forEach>
	</table>
	
	<!-- 리뷰 탭 -->
	<article id="reviewTap" class="reviewTap">
		<div class="score_top">
			<div class="score_wrap">
				<div class="score_star"></div>
				<div id="rating_avg_2"></div>
				<div id="rating_cnt"></div>
				<input type="button" id="writeBtn" value="리뷰 작성" />
			</div>
		</div>
		
		<!-- 리뷰 작성 폼 -->
		<div id="reviewFormContainer" style="display:none;">
			<form id="reviewFrm" method="post" enctype="multipart/form-data">
				<input type="hidden" id="hotel_code" name="hotel_code" value="${hotel_code}"/>
				<div>작성자</div>
				<div>comment<textarea rows="5" id="content" name="content"></textarea></div>
				<div>booking_code<input type="number" id="booking_code" name="booking_code"/></div>
				<div>rating<input type="number" id="rating_value" name="rating_value"/></div>
				<div>file<input type="file" id="photo" name="photo" /></div>
				<div><input type="button" id="insert" value="작성" />
				<input type="button" id="cancelInsert" value="취소" /></div>
			</form>
		</div>
		
		<!-- 리뷰 리스트 출력 -->
		<div id="reviewList"></div>
	</article>
</body>
</html>